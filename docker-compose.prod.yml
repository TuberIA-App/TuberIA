# ============================================
# Docker Compose - Production Configuration
# For VPS deployment with Traefik reverse proxy
# ============================================
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Prerequisites:
#   1. Create secrets files in ./secrets/ directory
#   2. Set DOMAIN_NAME environment variable or update labels below
#   3. Ensure MongoDB Atlas or managed MongoDB is configured
# ============================================
version: '3.8'

services:

  # Traefik Reverse Proxy with automatic SSL
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: always
    command:
      # API and dashboard (disable in production or secure properly)
      - "--api.dashboard=true"
      - "--api.insecure=false"  # Secure dashboard

      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"

      # Entrypoints
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"

      # HTTP to HTTPS redirect
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"

      # Let's Encrypt SSL
      - "--certificatesresolvers.letsencrypt.acme.email=${SSL_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"

      # Logging
      - "--log.level=INFO"
      - "--accesslog=true"

    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Dashboard (secure this in production!)

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-letsencrypt:/letsencrypt

    networks:
      - tuberia-network

    labels:
      # Dashboard authentication (change credentials!)
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      # Basic auth (generate with: htpasswd -nb admin your_password)
      # Default: admin / change_this_password
      - "traefik.http.routers.dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$ruca84Hq$$mbjdMZBAG.KWn7vfN/SNK/"

  # Frontend - Production build served by Nginx
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production  # Use production stage

    container_name: tuberia-frontend-prod
    restart: always

    # No direct port exposure - accessed via Traefik
    expose:
      - "3000"

    # Production environment variables
    environment:
      - NODE_ENV=production

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          memory: 128M

    # Security: read-only filesystem with necessary writable paths
    read_only: true
    tmpfs:
      - /tmp
      - /var/cache/nginx:uid=101,gid=101
      - /var/run:uid=101,gid=101
      - /var/tmp/nginx:uid=101,gid=101

    networks:
      - tuberia-network

    depends_on:
      backend:
        condition: service_healthy

    labels:
      - "traefik.enable=true"
      # Frontend routes
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN_NAME:-localhost}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      # Security headers
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.routers.frontend.middlewares=security-headers"

  # Backend - Production Node.js application
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production  # Use production stage

    container_name: tuberia-backend-prod
    restart: always

    # No direct port exposure - accessed via Traefik
    expose:
      - "5000"

    # Production environment variables
    environment:
      - NODE_ENV=production
      - PORT=5000
      # MongoDB connection - CONFIGURE THIS FOR YOUR MANAGED MONGODB
      # Example for MongoDB Atlas:
      # - MONGODB_URI=mongodb+srv://user:password@cluster.mongodb.net/tuberia?retryWrites=true&w=majority
      # For now, using containerized mongo (not recommended for production)
      - MONGODB_URI=mongodb://mongo:mongo@mongo:27017/tuberia?authSource=admin
      - FRONTEND_URL=https://${DOMAIN_NAME:-localhost}
      - LOG_LEVEL=error

    # Docker secrets for sensitive data (read from /run/secrets/ in container)
    secrets:
      - jwt_secret
      - jwt_refresh_secret
      - openrouter_api_key

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          memory: 256M

    networks:
      - tuberia-network
      - backend-internal

    depends_on:
      mongo:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    labels:
      - "traefik.enable=true"
      # API routes
      - "traefik.http.routers.backend.rule=Host(`${DOMAIN_NAME:-localhost}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend.loadbalancer.server.port=5000"
      # Rate limiting middleware
      - "traefik.http.middlewares.api-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.api-ratelimit.ratelimit.burst=50"
      - "traefik.http.routers.backend.middlewares=api-ratelimit"

  # MongoDB - Production (containerized - NOT RECOMMENDED)
  # For production, use MongoDB Atlas or managed service instead
  # See DEPLOYMENT.md for MongoDB Atlas setup
  mongo:
    image: mongo:7.0  # Use official image instead of custom build
    container_name: mongodb-prod
    restart: always

    # NO PORT EXPOSURE - internal network only
    expose:
      - "27017"

    # Credentials via environment (use secrets in real production)
    environment:
      - MONGO_INITDB_ROOT_USERNAME=mongo
      - MONGO_INITDB_ROOT_PASSWORD=mongo
      - MONGO_INITDB_DATABASE=tuberia_db

    # Persistent volume
    volumes:
      - mongo_data_prod:/data/db
      - ./mongo-backups:/backups  # For manual backups

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 512M

    # Internal network only
    networks:
      - backend-internal

    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

# Docker Secrets for sensitive data
secrets:
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  jwt_refresh_secret:
    file: ./secrets/jwt_refresh_secret.txt
  openrouter_api_key:
    file: ./secrets/openrouter_api_key.txt

# Volumes
volumes:
  mongo_data_prod:
    driver: local
  traefik-letsencrypt:
    driver: local

# Networks
networks:
  tuberia-network:
    driver: bridge
  backend-internal:
    driver: bridge
    internal: true  # No external access - backend and mongo only
